name: üì° Actualizaci√≥n y Limpieza Diaria de Listas IPTV

on:
  workflow_dispatch:
  schedule:
    # Primera ejecuci√≥n: 00:00 UTC (Medianoche)
    - cron: '0 0 * * *' 
    # Segunda ejecuci√≥n: 12:00 UTC (Mediod√≠a)
    - cron: '0 12 * * *' 

jobs:
  update_and_validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚¨áÔ∏è Checkout del Repositorio
        # Descarga el c√≥digo del repositorio
        uses: actions/checkout@v4

      - name: üêç Configuraci√≥n de Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: üì¶ Instalaci√≥n de Dependencias
        # Instala 'requests' desde tu requirements_scraper.txt
        run: pip install -r requirements_scraper.txt 

      - name: üõ†Ô∏è Ejecutar Script de Validaci√≥n y Filtrado (check_m3u.py)
        # Descarga, filtra cine, actualiza pa√≠ses, y valida enlaces
        run: python check_m3u.py

      - name: üí¨ Ejecutar Notificaci√≥n por Telegram (send_to_telegram.py)
        # Env√≠a el reporte de cambios
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: python send_to_telegram.py
        # NOTA: Aseg√∫rate de que los nombres de los secretos (secrets.TELEGRAM_...) sean correctos.

      - name: üíæ Configurar Git para Commit Autom√°tico
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
      - name: ‚¨ÜÔ∏è Commit y Push de Cambios
        run: |
          # 1. Agregar los archivos modificados
          git add *.m3u channels_history.json
          
          # 2. Commit con timestamp
          git commit -m "ü§ñ Actualizaci√≥n autom√°tica IPTV - $(date '+%Y-%m-%d %H:%M')"
          
          # 3. SOLUCI√ìN AL ERROR DE PUSH RECHAZADO: 
          # Descarga los √∫ltimos cambios remotos y aplica los commits del bot encima.
          git pull --rebase 
          
          # 4. Push final
          git push
