name: üì° Actualizaci√≥n y Limpieza Peri√≥dica de Listas IPTV

on:
  workflow_dispatch:
  schedule:
    # Ejecuci√≥n cada 12 horas: 00:00 UTC (Medianoche) y 12:00 UTC (Mediod√≠a)
    - cron: '0 0,12 * * *' 

jobs:
  update_and_validate:
    runs-on: ubuntu-latest
    
    # *** CORRECCI√ìN CRUCIAL PARA EL ERROR 403 (Permisos) ***
    permissions:
      contents: write # Esto permite que el bot suba los cambios (haga git push)
      
    steps:
      - name: ‚¨áÔ∏è Checkout del Repositorio
        uses: actions/checkout@v4

      - name: üêç Configuraci√≥n de Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: üì¶ Instalaci√≥n de Dependencias
        run: pip install -r requirements_scraper.txt 

      - name: üõ†Ô∏è Ejecutar Script de Validaci√≥n y Filtrado (check_m3u.py)
        run: python check_m3u.py

      - name: üí¨ Ejecutar Notificaci√≥n por Telegram (send_to_telegram.py)
        # Aseg√∫rate de que los secretos TELEGRAM_BOT_TOKEN y TELEGRAM_CHAT_ID est√©n configurados en tu repositorio.
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: python send_to_telegram.py

      - name: üíæ Configurar Git para Commit Autom√°tico
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
      - name: ‚¨ÜÔ∏è Commit y Push de Cambios
        run: |
          # 1. Agregar TODOS los archivos modificados (para evitar el error "unstaged changes")
          git add . 
          
          # 2. Commit 
          git commit --allow-empty -m "ü§ñ Actualizaci√≥n autom√°tica IPTV - $(date '+%Y-%m-%d %H:%M')"
          
          # 3. Solucionar el conflicto: Integra los √∫ltimos cambios remotos antes de subir
          git pull --rebase 
          
          # 4. Push final
          git push
